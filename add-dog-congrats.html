<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certify Your Dog | HTDA</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .congrats-banner {
            background: linear-gradient(135deg, var(--dark-maroon) 0%, var(--primary-maroon) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        .congrats-banner h2 {
            color: var(--accent-gold);
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        .diploma-preview {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 2rem 0;
        }
        .diploma-preview h3 {
            color: var(--primary-maroon);
            text-align: center;
            margin-bottom: 1rem;
        }
        #diploma-canvas {
            max-width: 100%;
            border: 2px solid var(--accent-gold);
            border-radius: 8px;
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--accent-gold);
            position: absolute;
            animation: fall 3s linear infinite;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="nav-container">
            <a href="index.html" class="logo">Holistic Therapy Dog<br>Association</a>
            <nav>
                <ul id="nav-links"></ul>
            </nav>
            <div class="nav-account" id="nav-account-links"></div>
        </div>
    </header>

    <main class="page-container">
        <div class="congrats-banner">
            <h2>ðŸŽ‰ Congratulations! ðŸŽ‰</h2>
            <p style="font-size: 1.2rem;">You've completed the self-certification! Now let's make it official.</p>
            <p>Complete the form below to receive your official embossed diploma.</p>
        </div>

        <div id="msg-box" class="status-msg" style="display: none;"></div>

        <form id="dogForm" style="max-width: 800px; margin: 2rem auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            
            <div class="diploma-preview">
                <h3>Preview Your Diploma</h3>
                <p style="text-align: center; color: #666; margin-bottom: 1rem;">
                    This is how your dog's name will appear on the official diploma.<br>
                    Please ensure the spelling is exactly as you want it!
                </p>
                <canvas id="diploma-canvas" width="1200" height="900"></canvas>
            </div>

            <div class="form-group">
                <label for="dog_name">Dog's Name (exactly as it should appear on the diploma)</label>
                <input type="text" id="dog_name" name="dog_name" required placeholder="e.g., Riley Farber">
            </div>

            <div class="form-group">
                <label for="state">State of Licensure</label>
                <select id="state" name="state" required>
                    <option value="">Select State</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                </select>
            </div>

            <div class="form-group">
                <label for="photo">Dog Photo (Optional)</label>
                <input type="file" id="photo" name="photo" accept="image/*">
                <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                    <button type="button" id="skip-btn" class="cta-button" style="background: transparent; border: 2px solid var(--accent-gold); color: var(--primary-maroon);" onclick="skipPhoto()">Skip Photo Upload</button>
                    <button type="button" id="unselect-btn" class="cta-button" style="display: none; background: transparent; border: 2px solid var(--primary-maroon); color: var(--primary-maroon);" onclick="unselectSkip()">Go Back / Upload Photo</button>
                </div>
                <div id="photo-skipped" style="display: none; background: #fff3cd; padding: 10px; border-radius: 4px; margin-top: 10px;">âœ“ Photo upload skipped - You can still go back and upload a photo using the button above</div>
            </div>

            <div class="form-group">
                <label for="coupon">Coupon Code (Optional)</label>
                <input type="text" id="coupon" name="coupon" placeholder="e.g., BETA2025">
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="terms" required>
                    I understand this is a commemorative certification and does not confer ADA rights
                </label>
            </div>

            <button type="submit" class="cta-button" style="width: 100%;" id="submitBtn">Proceed to Checkout - $99.99</button>
        </form>
    </main>

    <footer>
        <div class="footer-links">
            <a href="about.html">About Us</a>
            <a href="gallery.html">Gallery</a>
            <a href="verify.html">Verify License</a>
            <a href="contact.html">Contact</a>
            <a href="privacy-policy.html">Privacy</a>
            <a href="terms.html">Terms</a>
        </div>
        <p class="disclaimer">
            <strong>Disclaimer:</strong> The Holistic Therapy Dog certification is commemorative and does not confer legal rights under the ADA.
        </p>
        <p>&copy; 2025 Holistic Therapy Dog Association. All Rights Reserved.</p>
    </footer>

    <script src="api-config.js"></script>
    <script src="header.js"></script>
    <script src="footer.js"></script>
    <script>
        let photoSkipped = false;
        let photoUrl = null;
        let diplomaImage = new Image();
        let canvas, ctx;

        // Create confetti
        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.background = ['#B89A6A', '#B22234', '#FFD700'][Math.floor(Math.random() * 3)];
                document.querySelector('.congrats-banner').appendChild(confetti);
            }
        }
        createConfetti();

        // Load diploma image
        diplomaImage.src = 'blank.png';
        diplomaImage.onload = function() {
            drawDiploma();
        };

        function drawDiploma() {
            canvas = document.getElementById('diploma-canvas');
            ctx = canvas.getContext('2d');
            
            // Draw the blank diploma
            ctx.drawImage(diplomaImage, 0, 0, canvas.width, canvas.height);
            
            // Draw the dog's name
            const dogName = document.getElementById('dog_name').value || '[Dog Name]';
            ctx.font = '60px "Playfair Display", serif';
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.fillText(dogName, canvas.width / 2, 640);
        }

        // Update diploma preview as user types
        document.getElementById('dog_name').addEventListener('input', drawDiploma);

        function showMsg(text, type) {
            const msgBox = document.getElementById('msg-box');
            msgBox.textContent = text;
            msgBox.className = `status-msg ${type}`;
            msgBox.style.display = 'block';
            window.scrollTo(0, 0);
        }

        function skipPhoto() {
            photoSkipped = true;
            document.getElementById('photo').disabled = true;
            document.getElementById('photo').value = '';
            document.getElementById('photo-skipped').style.display = 'block';
            document.getElementById('skip-btn').style.display = 'none';
            document.getElementById('unselect-btn').style.display = 'inline-block';
        }

        function unselectSkip() {
            photoSkipped = false;
            document.getElementById('photo').disabled = false;
            document.getElementById('photo-skipped').style.display = 'none';
            document.getElementById('skip-btn').style.display = 'inline-block';
            document.getElementById('unselect-btn').style.display = 'none';
        }

        document.getElementById('dogForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            try {
                const photoFile = document.getElementById('photo').files[0];
                if (photoFile && !photoSkipped) {
                    const formData = new FormData();
                    formData.append('photo', photoFile);

                    const uploadResponse = await fetch(`${API_CONFIG.endpoints.dogs}/upload-photo`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });
                    const uploadData = await uploadResponse.json();
                    if (uploadData.success) {
                        photoUrl = uploadData.url;
                    }
                }

                const checkoutData = {
                    dog_name: document.getElementById('dog_name').value,
                    state: document.getElementById('state').value,
                    coupon: document.getElementById('coupon').value,
                    photo_url: photoUrl
                };

                const response = await fetch(API_CONFIG.endpoints.checkout, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(checkoutData)
                });

                const data = await response.json();

                if (data.success) {
                    if (data.free) {
                        window.location.href = `payment-success.html?license=${data.licenseId}`;
                    } else {
                        window.location.href = data.sessionUrl;
                    }
                } else {
                    showMsg(data.error || 'Checkout failed', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Try Again';
                }
            } catch (error) {
                showMsg('Error: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Try Again';
            }
        });
    </script>
</body>
</html>
