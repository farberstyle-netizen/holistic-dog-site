<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | HTDA</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .checkout-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .checkout-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .checkout-header {
            background: linear-gradient(135deg, var(--dark-maroon) 0%, var(--primary-maroon) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .checkout-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            margin: 0;
            color: var(--accent-gold);
        }
        
        .checkout-header p {
            margin: 0.5rem 0 0;
            opacity: 0.9;
        }
        
        .checkout-body {
            padding: 2rem;
        }
        
        .order-summary {
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .order-summary h3 {
            color: var(--primary-maroon);
            margin: 0 0 1rem;
            font-family: 'Playfair Display', serif;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-item.total {
            font-weight: bold;
            font-size: 1.2rem;
            border-top: 2px solid var(--primary-maroon);
            margin-top: 0.5rem;
            padding-top: 1rem;
        }
        
        .order-item .label {
            color: #666;
        }
        
        .order-item .value {
            color: #333;
            font-weight: 600;
        }
        
        .order-item.total .value {
            color: var(--primary-maroon);
        }
        
        .dog-name-display {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            color: var(--primary-maroon);
        }
        
        .shipping-info {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .shipping-info h3 {
            color: var(--primary-maroon);
            margin: 0 0 1rem;
            font-family: 'Playfair Display', serif;
        }
        
        .shipping-info p {
            margin: 0.25rem 0;
            color: #555;
        }
        
        .coupon-section {
            margin-bottom: 2rem;
        }
        
        .coupon-section label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .coupon-row {
            display: flex;
            gap: 0.5rem;
        }
        
        .coupon-row input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .coupon-row button {
            padding: 0.75rem 1.5rem;
            background: var(--primary-maroon);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .coupon-row button:hover {
            background: var(--dark-maroon);
        }
        
        .coupon-message {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .coupon-message.success {
            background: #d4edda;
            color: #155724;
        }
        
        .coupon-message.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .checkout-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .pay-button {
            background: var(--accent-gold);
            color: var(--dark-maroon);
            padding: 1.25rem 2rem;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .pay-button:hover {
            background: #c9a432;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .pay-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .back-link {
            text-align: center;
            color: #666;
        }
        
        .back-link a {
            color: var(--primary-maroon);
        }
        
        .secure-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            color: #666;
            font-size: 0.9rem;
        }
        
        .secure-badge svg {
            width: 16px;
            height: 16px;
        }
        
        .what-you-get {
            background: #fff9e6;
            border: 1px solid var(--accent-gold);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .what-you-get h3 {
            color: var(--primary-maroon);
            margin: 0 0 1rem;
            font-family: 'Playfair Display', serif;
        }
        
        .what-you-get ul {
            margin: 0;
            padding-left: 1.5rem;
        }
        
        .what-you-get li {
            margin: 0.5rem 0;
            color: #555;
        }
        
        #error-message {
            display: none;
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .loading-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
    </style>
</head>
<body>
    <header>
        <div class="nav-container">
            <a href="index.html" class="logo">Holistic Therapy Dog<br>Association</a>
            <nav>
                <ul id="nav-links"></ul>
            </nav>
            <div class="nav-account" id="nav-account-links"></div>
        </div>
    </header>

    <main class="checkout-container">
        <div id="error-message"></div>
        
        <div class="checkout-card">
            <div class="checkout-header">
                <h1>Complete Your Order</h1>
                <p>Review your certification details</p>
            </div>
            
            <div class="checkout-body">
                <div id="loading" class="loading-state">
                    <p>Loading your order...</p>
                </div>
                
                <div id="checkout-content" style="display: none;">
                    <div class="order-summary">
                        <h3>Order Summary</h3>
                        <div class="order-item">
                            <span class="label">Certification for:</span>
                            <span class="value dog-name-display" id="display-dog-name">-</span>
                        </div>
                        <div class="order-item">
                            <span class="label">State of Licensure:</span>
                            <span class="value" id="display-state">-</span>
                        </div>
                        <div class="order-item">
                            <span class="label">Frame Orientation:</span>
                            <span class="value" id="display-frame">-</span>
                        </div>
                        <div class="order-item">
                            <span class="label">Official Diploma Package</span>
                            <span class="value">$99.99</span>
                        </div>
                        <div class="order-item" id="discount-row" style="display: none;">
                            <span class="label">Discount</span>
                            <span class="value" id="discount-amount" style="color: green;">-$0.00</span>
                        </div>
                        <div class="order-item total">
                            <span class="label">Total</span>
                            <span class="value" id="display-total">$99.99</span>
                        </div>
                    </div>
                    
                    <div id="shipping-section" class="shipping-info">
                        <h3>Shipping To</h3>
                        <p id="display-shipping-name">-</p>
                        <p id="display-shipping-address">-</p>
                        <p id="display-shipping-city-state">-</p>
                    </div>
                    
                    <div class="what-you-get">
                        <h3>What You'll Receive</h3>
                        <ul>
                            <li>Official embossed diploma on premium parchment paper</li>
                            <li>Elegant leatherette diploma holder</li>
                            <li>Unique license ID in our verification database</li>
                            <li>2-year certification validity</li>
                            <li>Free shipping within the USA</li>
                        </ul>
                    </div>
                    
                    <div class="coupon-section">
                        <label for="coupon">Have a promo code?</label>
                        <div class="coupon-row">
                            <input type="text" id="coupon" placeholder="Enter code">
                            <button type="button" onclick="applyCoupon()">Apply</button>
                        </div>
                        <div id="coupon-message" class="coupon-message" style="display: none;"></div>
                    </div>
                    
                    <div class="checkout-actions">
                        <button class="pay-button" id="pay-button" onclick="proceedToPayment()">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            Pay Now - <span id="pay-amount">$99.99</span>
                        </button>
                        
                        <p class="back-link">
                            <a href="add-dog.html">‚Üê Back to edit details</a>
                        </p>
                        
                        <div class="secure-badge">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                            </svg>
                            Secure payment powered by Stripe
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer></footer>

    <script src="api-config.js"></script>
    <script src="header.js"></script>
    <script src="footer.js"></script>
    <script>
        let orderData = null;
        let appliedCoupon = null;
        let currentTotal = 99.99;
        
        // Load order data from sessionStorage
        document.addEventListener('DOMContentLoaded', function() {
            // Get order data from sessionStorage
            const storedData = sessionStorage.getItem('checkout_data');
            if (!storedData) {
                showError('No order data found. Please start again.');
                setTimeout(() => {
                    window.location.href = 'add-dog.html';
                }, 2000);
                return;
            }
            
            orderData = JSON.parse(storedData);
            displayOrderData();
        });
        
        function displayOrderData() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('checkout-content').style.display = 'block';
            
            // Display dog info
            document.getElementById('display-dog-name').textContent = orderData.dog_name;
            document.getElementById('display-state').textContent = getStateName(orderData.state);
            document.getElementById('display-frame').textContent = capitalizeFirst(orderData.frame_orientation);
            
            // Display shipping info
            if (orderData.is_gift && orderData.gift_name) {
                document.getElementById('display-shipping-name').textContent = orderData.gift_name;
                document.getElementById('display-shipping-address').textContent = orderData.gift_address;
                document.getElementById('display-shipping-city-state').textContent = 
                    `${orderData.gift_city}, ${orderData.gift_state} ${orderData.gift_zip}`;
            } else {
                // Will need to fetch user's address
                fetchUserAddress();
            }
            
            // Pre-fill coupon if one was entered
            if (orderData.coupon) {
                document.getElementById('coupon').value = orderData.coupon;
                applyCoupon();
            }
        }
        
        async function fetchUserAddress() {
            try {
                const response = await fetch(`${API_CONFIG.endpoints.account}/profile`, {
                    headers: { }
                });
                const data = await response.json();
                if (data.success && data.user) {
                    const user = data.user;
                    document.getElementById('display-shipping-name').textContent = user.name || user.email;
                    document.getElementById('display-shipping-address').textContent = user.address || 'Address on file';
                    document.getElementById('display-shipping-city-state').textContent = 
                        user.city ? `${user.city}, ${user.state} ${user.zip}` : 'Will use address on file';
                }
            } catch (e) {
                console.error('Could not fetch user address:', e);
                document.getElementById('display-shipping-name').textContent = 'Your address on file';
                document.getElementById('display-shipping-address').textContent = '';
                document.getElementById('display-shipping-city-state').textContent = '';
            }
        }
        
        function applyCoupon() {
            const couponCode = document.getElementById('coupon').value.trim().toUpperCase();
            const messageEl = document.getElementById('coupon-message');
            
            if (!couponCode) {
                messageEl.style.display = 'none';
                return;
            }
            
            // Known coupons (actual validation happens on server)
            if (couponCode === 'BETA2025') {
                appliedCoupon = couponCode;
                currentTotal = 0;
                messageEl.textContent = '‚úì BETA2025 applied - FREE certification!';
                messageEl.className = 'coupon-message success';
                messageEl.style.display = 'block';
                document.getElementById('discount-row').style.display = 'flex';
                document.getElementById('discount-amount').textContent = '-$99.99';
                document.getElementById('display-total').textContent = '$0.00';
                document.getElementById('pay-amount').textContent = '$0.00';
                document.getElementById('pay-button').innerHTML = 'üéâ Complete Free Certification';
            } else if (couponCode === 'TEST99') {
                appliedCoupon = couponCode;
                currentTotal = 1.00;
                messageEl.textContent = '‚úì TEST99 applied - $98.99 discount!';
                messageEl.className = 'coupon-message success';
                messageEl.style.display = 'block';
                document.getElementById('discount-row').style.display = 'flex';
                document.getElementById('discount-amount').textContent = '-$98.99';
                document.getElementById('display-total').textContent = '$1.00';
                document.getElementById('pay-amount').textContent = '$1.00';
            } else {
                // Unknown coupon - will be validated by Stripe
                appliedCoupon = couponCode;
                messageEl.textContent = 'Coupon will be validated at payment';
                messageEl.className = 'coupon-message success';
                messageEl.style.display = 'block';
            }
            
            // Store coupon in order data
            orderData.coupon = couponCode;
            sessionStorage.setItem('checkout_data', JSON.stringify(orderData));
        }
        
        async function proceedToPayment() {
            const payButton = document.getElementById('pay-button');
            payButton.disabled = true;
            payButton.textContent = 'Processing...';
            
            
            try {
                const response = await fetch(API_CONFIG.endpoints.checkout, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                const data = await response.json();
                console.log('Checkout response:', data);
                
                if (data.success) {
                    // Clear session storage
                    sessionStorage.removeItem('checkout_data');
                    
                    if (data.free) {
                        // Free order - go directly to success
                        window.location.href = `payment-success.html?license=${data.licenseId}`;
                    } else if (data.sessionUrl) {
                        // Redirect to Stripe
                        window.location.href = data.sessionUrl;
                    } else {
                        showError('Payment link not received. Please try again.');
                        payButton.disabled = false;
                        payButton.innerHTML = 'Try Again';
                    }
                } else {
                    showError(data.error || 'Checkout failed. Please try again.');
                    payButton.disabled = false;
                    payButton.innerHTML = 'Try Again';
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showError('Connection error. Please check your internet and try again.');
                payButton.disabled = false;
                payButton.innerHTML = 'Try Again';
            }
        }
        
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            window.scrollTo(0, 0);
        }
        
        function getStateName(abbr) {
            const states = {
                'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas',
                'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
                'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii', 'ID': 'Idaho',
                'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa', 'KS': 'Kansas',
                'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
                'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi',
                'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada',
                'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico', 'NY': 'New York',
                'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio', 'OK': 'Oklahoma',
                'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
                'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah',
                'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia',
                'WI': 'Wisconsin', 'WY': 'Wyoming'
            };
            return states[abbr] || abbr;
        }
        
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
    </script>
</body>
</html>
