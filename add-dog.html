<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certify Your Dog | HTDA</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .congrats-banner {
            background: linear-gradient(135deg, var(--dark-maroon) 0%, var(--primary-maroon) 100%);
            color: white;
            padding: 4rem 2rem;
            text-align: center;
            margin-bottom: 2rem;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        .congrats-banner h2 {
            color: var(--accent-gold);
            font-family: 'Playfair Display', serif;
            font-size: 4rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .congrats-banner p {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
        }
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        .diploma-preview {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 2rem 0;
        }
        .diploma-preview h3 {
            color: var(--primary-maroon);
            text-align: center;
            margin-bottom: 1rem;
        }
        #diploma-canvas {
            max-width: 100%;
            border: 2px solid var(--accent-gold);
            border-radius: 8px;
        }
        
        .frame-options {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }
        .frame-option {
            flex: 1;
            min-width: 150px;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .frame-option:hover {
            border-color: var(--accent-gold);
        }
        .frame-option.selected {
            border-color: var(--primary-maroon);
            background: rgba(178, 34, 52, 0.05);
        }
        .frame-option input[type="radio"] {
            display: none;
        }
        .frame-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        .photo-preview {
            margin-top: 1rem;
            max-width: 400px;
        }
        .photo-preview img {
            width: 100%;
            border-radius: 8px;
            border: 2px solid var(--accent-gold);
        }
        .photo-preview.portrait img {
            aspect-ratio: 3/4;
            object-fit: cover;
        }
        .photo-preview.landscape img {
            aspect-ratio: 4/3;
            object-fit: cover;
        }
        .photo-preview.square img {
            aspect-ratio: 1/1;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <canvas id="confetti-canvas"></canvas>
    <header>
        <div class="nav-container">
            <a href="index.html" class="logo">Holistic Therapy Dog<br>Association</a>
            <nav>
                <ul id="nav-links"></ul>
            </nav>
            <div class="nav-account" id="nav-account-links"></div>
        </div>
    </header>

    <main class="page-container" style="position: relative; z-index: 1;">
        <div class="congrats-banner">
            <h2>Congratulations!</h2>
            <p style="font-size: 1.4rem;">You've completed the self-certification! Now let's make it official.</p>
            <p style="font-size: 1.1rem;">Complete the form below to receive your official embossed diploma.</p>
        </div>

        <div id="msg-box" class="status-msg" style="display: none;"></div>

        <form id="dogForm" style="max-width: 800px; margin: 2rem auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            
            <div class="diploma-preview">
                <h3>Preview Your Diploma</h3>
                <p style="text-align: center; color: #666; margin-bottom: 1rem;">
                    This is how your dog's name will appear on the official diploma.<br>
                    Please ensure the spelling is exactly as you want it!
                </p>
                <canvas id="diploma-canvas" width="1200" height="937"></canvas>
            </div>

            <div class="form-group">
                <label for="dog_name">Dog's Name (exactly as it should appear on the diploma)</label>
                <input type="text" id="dog_name" name="dog_name" required placeholder="e.g., Riley Farber">
            </div>

            <div class="form-group">
                <label for="state">State of Licensure</label>
                <select id="state" name="state" required>
                    <option value="">Select State</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                </select>
            </div>

            <div class="form-group">
                <label for="photo">Dog Photo (Optional)</label>
                <input type="file" id="photo" name="photo" accept="image/*" onchange="previewPhoto()">
                
                <div id="photo-preview-container" style="display: none;">
                    <p style="margin-top: 1rem; font-weight: 600;">Preview of how your photo will appear:</p>
                    <div id="photo-preview" class="photo-preview square">
                        <img id="preview-img" src="" alt="Photo preview">
                    </div>
                </div>

                <div style="margin-top: 1rem;">
                    <label style="font-weight: 600; margin-bottom: 0.5rem;">Choose Photo Frame:</label>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Select how you'd like your photo displayed in the gallery to avoid cropping</p>
                    <div class="frame-options">
                        <label class="frame-option" onclick="selectFrame('portrait')">
                            <input type="radio" name="frame_orientation" value="portrait">
                            <div class="frame-icon">üì±</div>
                            <strong>Portrait</strong>
                            <p style="font-size: 0.85rem; color: #666;">Vertical (3:4)</p>
                        </label>
                        <label class="frame-option selected" onclick="selectFrame('square')">
                            <input type="radio" name="frame_orientation" value="square" checked>
                            <div class="frame-icon">‚¨õ</div>
                            <strong>Square</strong>
                            <p style="font-size: 0.85rem; color: #666;">1:1 Ratio</p>
                        </label>
                        <label class="frame-option" onclick="selectFrame('landscape')">
                            <input type="radio" name="frame_orientation" value="landscape">
                            <div class="frame-icon">üñºÔ∏è</div>
                            <strong>Landscape</strong>
                            <p style="font-size: 0.85rem; color: #666;">Horizontal (4:3)</p>
                        </label>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                    <button type="button" id="skip-btn" class="cta-button" style="background: transparent; border: 2px solid var(--accent-gold); color: var(--primary-maroon);" onclick="skipPhoto()">Skip Photo Upload</button>
                    <button type="button" id="unselect-btn" class="cta-button" style="display: none; background: transparent; border: 2px solid var(--primary-maroon); color: var(--primary-maroon);" onclick="unselectSkip()">Go Back / Upload Photo</button>
                </div>
                <div id="photo-skipped" style="display: none; background: #fff3cd; padding: 10px; border-radius: 4px; margin-top: 10px;">‚úì Photo upload skipped - You can still go back and upload a photo using the button above</div>
            </div>

            <!-- Gift Option -->
            <div class="form-group" style="background: #faf6f0; padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;">
                    <input type="checkbox" id="is_gift" name="is_gift" style="width: 20px; height: 20px;" onchange="toggleGiftAddress()">
                    üéÅ This is a Gift
                </label>
                <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem; margin-bottom: 0;">Check this box to ship to a different address</p>
            </div>

            <!-- Gift Shipping Address (hidden by default) -->
            <div id="gift-address-section" style="display: none; margin-top: 1.5rem; padding: 1.5rem; border: 2px solid var(--accent-gold); border-radius: 8px;">
                <h3 style="color: var(--primary-maroon); margin-top: 0; margin-bottom: 1rem;">Gift Recipient's Address</h3>
                
                <div class="form-group">
                    <label for="gift_name">Recipient's Full Name</label>
                    <input type="text" id="gift_name" name="gift_name">
                </div>
                
                <div class="form-group">
                    <label for="gift_address">Street Address</label>
                    <input type="text" id="gift_address" name="gift_address">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="gift_city">City</label>
                        <input type="text" id="gift_city" name="gift_city">
                    </div>
                    <div class="form-group">
                        <label for="gift_state">State</label>
                        <input type="text" id="gift_state" name="gift_state" maxlength="2" placeholder="e.g., CA">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="gift_zip">ZIP Code</label>
                    <input type="text" id="gift_zip" name="gift_zip" pattern="[0-9]{5}" maxlength="5">
                </div>
            </div>

            <div class="form-group">
                <label for="coupon">Coupon Code (Optional)</label>
                <input type="text" id="coupon" name="coupon" placeholder="e.g., BETA2025">
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="terms" required>
                    I understand this is a commemorative certification and does not confer ADA rights
                </label>
            </div>

            <button type="submit" class="cta-button" style="width: 100%;" id="submitBtn">Proceed to Checkout - $99.99</button>
        </form>
    </main>

    <footer>
        <div class="footer-links">
            <a href="about.html">About Us</a>
            <a href="gallery.html">Gallery</a>
            <a href="verify.html">Verify License</a>
            <a href="contact.html">Contact</a>
            <a href="privacy-policy.html">Privacy</a>
            <a href="terms.html">Terms</a>
        </div>
        <p class="disclaimer">
            <strong>Disclaimer:</strong> The Holistic Therapy Dog certification is commemorative and does not confer legal rights under the ADA.
        </p>
        <p>&copy; 2025 Holistic Therapy Dog Association. All Rights Reserved.</p>
    </footer>

    <script src="header.js"></script>
    <script src="footer.js"></script>
    <script>
        let photoSkipped = false;
        let photoUrl = null;
        let diplomaImage = new Image();
        let canvas, ctx;
        let currentFrame = 'square';

        // Toggle gift address section
        function toggleGiftAddress() {
            const isGift = document.getElementById('is_gift').checked;
            const giftSection = document.getElementById('gift-address-section');
            giftSection.style.display = isGift ? 'block' : 'none';
            
            // Set required on gift fields when visible
            const giftFields = ['gift_name', 'gift_address', 'gift_city', 'gift_state', 'gift_zip'];
            giftFields.forEach(field => {
                document.getElementById(field).required = isGift;
            });
        }

        // Create confetti
        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.background = ['#B89A6A', '#B22234', '#FFD700'][Math.floor(Math.random() * 3)];
                document.querySelector('.congrats-banner').appendChild(confetti);
            }
        }
        createConfetti();

        // Load diploma image
        diplomaImage.src = 'new-blank.png';
        diplomaImage.onload = function() {
            drawDiploma();
        };

        function drawDiploma() {
            canvas = document.getElementById('diploma-canvas');
            ctx = canvas.getContext('2d');
            
            // Fill with white background first
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw the blank diploma
            ctx.drawImage(diplomaImage, 0, 0, canvas.width, canvas.height);
            
            // Draw the dog's name (below "Hereby Certifies", above "The Title and Certification of")
            const dogName = document.getElementById('dog_name').value || '[Dog Name]';
            ctx.font = 'bold 42px "Playfair Display", serif';
            ctx.fillStyle = '#1a1a1a';
            ctx.textAlign = 'center';
            ctx.fillText(dogName.toUpperCase(), canvas.width / 2, 410);
            
            // Draw the date (below "Given This")
            const today = new Date();
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            const dateStr = today.toLocaleDateString('en-US', { day: 'numeric' }) + getDaySuffix(today.getDate()) + ' Day of ' + today.toLocaleDateString('en-US', { month: 'long' }) + ', ' + numberToWords(today.getFullYear());
            ctx.font = '20px "Playfair Display", serif';
            ctx.fillStyle = '#1a1a1a';
            ctx.fillText(dateStr.toUpperCase(), canvas.width / 2, 565);
        }
        
        function getDaySuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }
        
        function numberToWords(num) {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            
            if (num >= 2000 && num < 3000) {
                const remainder = num - 2000;
                if (remainder === 0) return 'Two-Thousand';
                if (remainder < 20) return 'Two-Thousand and ' + ones[remainder];
                if (remainder < 100) {
                    const t = Math.floor(remainder / 10);
                    const o = remainder % 10;
                    return 'Two-Thousand and ' + tens[t] + (o > 0 ? '-' + ones[o] : '');
                }
            }
            return num.toString();
        }

        // Update diploma preview as user types
        document.getElementById('dog_name').addEventListener('input', drawDiploma);

        function selectFrame(frame) {
            currentFrame = frame;
            document.querySelectorAll('.frame-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            // Update preview frame
            const preview = document.getElementById('photo-preview');
            preview.className = 'photo-preview ' + frame;
        }

        function previewPhoto() {
            const file = document.getElementById('photo').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('photo-preview-container').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function showMsg(text, type) {
            const msgBox = document.getElementById('msg-box');
            msgBox.textContent = text;
            msgBox.className = `status-msg ${type}`;
            msgBox.style.display = 'block';
            window.scrollTo(0, 0);
        }

        function skipPhoto() {
            photoSkipped = true;
            document.getElementById('photo').disabled = true;
            document.getElementById('photo').value = '';
            document.getElementById('photo-skipped').style.display = 'block';
            document.getElementById('skip-btn').style.display = 'none';
            document.getElementById('unselect-btn').style.display = 'inline-block';
            document.getElementById('photo-preview-container').style.display = 'none';
        }

        function unselectSkip() {
            photoSkipped = false;
            document.getElementById('photo').disabled = false;
            document.getElementById('photo-skipped').style.display = 'none';
            document.getElementById('skip-btn').style.display = 'inline-block';
            document.getElementById('unselect-btn').style.display = 'none';
        }

        document.getElementById('dogForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            const token = localStorage.getItem('session_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const photoFile = document.getElementById('photo').files[0];
                if (photoFile && !photoSkipped) {
                    const formData = new FormData();
                    formData.append('photo', photoFile);
                    formData.append('token', token);

                    const uploadResponse = await fetch('https://api-dogs.farberstyle.workers.dev/upload-photo', {
                        method: 'POST',
                        body: formData
                    });
                    const uploadData = await uploadResponse.json();
                    if (uploadData.success) {
                        photoUrl = uploadData.url;
                    }
                }

                const isGift = document.getElementById('is_gift').checked;
                
                const checkoutData = {
                    dog_name: document.getElementById('dog_name').value,
                    state: document.getElementById('state').value,
                    coupon: document.getElementById('coupon').value,
                    photo_url: photoUrl,
                    frame_orientation: document.querySelector('input[name="frame_orientation"]:checked').value,
                    is_gift: isGift
                };

                // Add gift shipping address if it's a gift
                if (isGift) {
                    checkoutData.gift_name = document.getElementById('gift_name').value;
                    checkoutData.gift_address = document.getElementById('gift_address').value;
                    checkoutData.gift_city = document.getElementById('gift_city').value;
                    checkoutData.gift_state = document.getElementById('gift_state').value;
                    checkoutData.gift_zip = document.getElementById('gift_zip').value;
                }

                const response = await fetch('https://api-checkout.farberstyle.workers.dev', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(checkoutData)
                });

                const data = await response.json();

                if (data.success) {
                    if (data.free) {
                        window.location.href = `payment-success.html?license=${data.licenseId}`;
                    } else {
                        window.location.href = data.sessionUrl;
                    }
                } else {
                    showMsg(data.error || 'Checkout failed', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Try Again';
                }
            } catch (error) {
                showMsg('Error: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Try Again';
            }
        });

        // Confetti animation
        (function() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
            
            const colors = ['#B8860B', '#DAA520', '#FFD700', '#B22234', '#8B0000', '#FFFFFF', '#F5F5DC'];
            const confettiCount = 150;
            const confetti = [];
            
            for (let i = 0; i < confettiCount; i++) {
                confetti.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    w: Math.random() * 10 + 5,
                    h: Math.random() * 6 + 4,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speed: Math.random() * 3 + 2,
                    angle: Math.random() * 360,
                    spin: Math.random() * 0.2 - 0.1,
                    drift: Math.random() * 2 - 1
                });
            }
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                confetti.forEach(c => {
                    ctx.save();
                    ctx.translate(c.x + c.w/2, c.y + c.h/2);
                    ctx.rotate(c.angle * Math.PI / 180);
                    ctx.fillStyle = c.color;
                    ctx.fillRect(-c.w/2, -c.h/2, c.w, c.h);
                    ctx.restore();
                    
                    c.y += c.speed;
                    c.x += c.drift;
                    c.angle += c.spin * 10;
                    
                    if (c.y > canvas.height + 20) {
                        c.y = -20;
                        c.x = Math.random() * canvas.width;
                    }
                });
                
                requestAnimationFrame(animate);
            }
            
            animate();
            
            // Stop confetti after 5 seconds
            setTimeout(() => {
                canvas.style.opacity = '0';
                canvas.style.transition = 'opacity 2s';
                setTimeout(() => canvas.remove(), 2000);
            }, 5000);
        })();
    </script>
</body>
</html>
