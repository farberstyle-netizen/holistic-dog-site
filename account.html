<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account | HTDA</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .account-tabs { display: flex; gap: 1rem; margin: 2rem 0; border-bottom: 2px solid #ddd; flex-wrap: wrap; }
        .tab-button { padding: 1rem 2rem; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: 600; font-family: 'Playfair Display', serif; letter-spacing: 0.02em; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-button:hover { color: var(--primary-maroon); }
        .tab-button.active { color: var(--primary-maroon); border-bottom-color: var(--primary-maroon); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-section { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 600px; }
        
        /* Current Info Display Styles */
        .current-info-box { background: #f9f9f9; padding: 1.5rem; border-radius: 6px; border: 1px solid #eee; margin-bottom: 1.5rem; }
        .current-info-row { display: flex; margin-bottom: 0.5rem; }
        .current-info-label { font-weight: bold; width: 120px; color: #555; }
        .current-info-val { color: #333; font-weight: 500; }
        .edit-btn-container { margin-top: 1rem; }
    </style>
</head>
<body>
    <header>
        <div class="nav-container">
            <a href="index.html" class="logo">Holistic Therapy<br>Dog Association</a>
            <nav><ul id="nav-links"></ul></nav>
            <div class="nav-account" id="nav-account-links"></div>
        </div>
    </header>

    <main class="page-container">
        <h1>My Account</h1>
        <div id="msg-box" class="status-msg" style="display: none;"></div>

        <div class="account-tabs">
            <button class="tab-button active" onclick="switchTab('dogs')">My Dogs</button>
            <button class="tab-button" onclick="switchTab('shipping')">Shipping Address</button>
            <button class="tab-button" onclick="switchTab('billing')">Billing Address</button>
            <button class="tab-button" onclick="switchTab('password')">Change Password</button>
            <button class="tab-button" onclick="switchTab('orders')">Order History</button>
        </div>

        <div id="dogs-tab" class="tab-content active">
            <div id="dogs-container">
                <p>Loading your dogs...</p>
            </div>
            <a href="add-dog.html" class="cta-button" style="display: inline-block; margin-top: 2rem;">Certify Another Dog</a>
        </div>

        <div id="shipping-tab" class="tab-content">
            <div class="form-section">
                <h2 style="color: var(--primary-maroon); margin-bottom: 1rem;">Shipping Address</h2>
                
                <div id="shipping-view" class="current-info-box">
                    <div class="current-info-row"><span class="current-info-label">Name:</span><span id="view_ship_name" class="current-info-val">Loading...</span></div>
                    <div class="current-info-row"><span class="current-info-label">Address:</span><span id="view_ship_address" class="current-info-val">...</span></div>
                    <div class="current-info-row"><span class="current-info-label">City/State:</span><span id="view_ship_citystate" class="current-info-val">...</span></div>
                    
                    <div class="edit-btn-container">
                        <button onclick="toggleEdit('shipping')" class="cta-button" style="padding: 10px 20px; font-size: 0.9rem; background: #eee; color: #333;">Edit Address</button>
                    </div>
                </div>

                <form id="shippingForm" style="display: none;">
                    <div class="form-group"><label>Full Name</label><input type="text" id="ship_name" name="ship_name"></div>
                    <div class="form-group"><label>Street Address</label><input type="text" id="ship_address" name="ship_address"></div>
                    <div class="form-group"><label>City</label><input type="text" id="ship_city" name="ship_city"></div>
                    <div class="form-group"><label>State</label><input type="text" id="ship_state" name="ship_state"></div>
                    <div class="form-group"><label>ZIP Code</label><input type="text" id="ship_zip" name="ship_zip"></div>
                    <button type="submit" class="cta-button" style="width: 100%;">Save Changes</button>
                    <button type="button" onclick="toggleEdit('shipping')" style="background:none; border:none; color:#666; margin-top:10px; cursor:pointer; width:100%;">Cancel</button>
                </form>
            </div>
        </div>

        <div id="billing-tab" class="tab-content">
            <div class="form-section">
                <h2 style="color: var(--primary-maroon); margin-bottom: 1rem;">Billing Address</h2>
                
                <div id="billing-view" class="current-info-box">
                    <div class="current-info-row"><span class="current-info-label">Name:</span><span id="view_bill_name" class="current-info-val">Loading...</span></div>
                    <div class="current-info-row"><span class="current-info-label">Address:</span><span id="view_bill_address" class="current-info-val">...</span></div>
                    <div class="current-info-row"><span class="current-info-label">City/State:</span><span id="view_bill_citystate" class="current-info-val">...</span></div>
                    
                    <div class="edit-btn-container">
                        <button onclick="toggleEdit('billing')" class="cta-button" style="padding: 10px 20px; font-size: 0.9rem; background: #eee; color: #333;">Edit Address</button>
                    </div>
                </div>

                <form id="billingForm" style="display: none;">
                    <div class="form-group"><label>Full Name</label><input type="text" id="bill_name" name="bill_name"></div>
                    <div class="form-group"><label>Street Address</label><input type="text" id="bill_address" name="bill_address"></div>
                    <div class="form-group"><label>City</label><input type="text" id="bill_city" name="bill_city"></div>
                    <div class="form-group"><label>State</label><input type="text" id="bill_state" name="bill_state"></div>
                    <div class="form-group"><label>ZIP Code</label><input type="text" id="bill_zip" name="bill_zip"></div>
                    <button type="submit" class="cta-button" style="width: 100%;">Save Changes</button>
                    <button type="button" onclick="toggleEdit('billing')" style="background:none; border:none; color:#666; margin-top:10px; cursor:pointer; width:100%;">Cancel</button>
                </form>
            </div>
        </div>

        <div id="password-tab" class="tab-content">
            <div class="form-section">
                <h2 style="color: var(--primary-maroon); margin-bottom: 1.5rem;">Change Password</h2>
                <form id="passwordForm">
                    <div class="form-group"><label>Current Password</label><input type="password" id="current_password" name="current_password" required></div>
                    <div class="form-group"><label>New Password</label><input type="password" id="new_password" name="new_password" required></div>
                    <div class="form-group"><label>Confirm New Password</label><input type="password" id="confirm_password" name="confirm_password" required></div>
                    <button type="submit" class="cta-button" style="width: 100%;">Change Password</button>
                </form>
            </div>
        </div>

        <div id="orders-tab" class="tab-content">
            <div id="orders-container"><p>Loading orders...</p></div>
        </div>
    </main>

    <footer>
        <div class="footer-links"><a href="about.html">About</a><a href="gallery.html">Gallery</a><a href="verify.html">Verify</a></div>
        <p class="disclaimer">The Holistic Therapy Dog certification is commemorative.</p>
        <p>&copy; 2025 HTDA.</p>
    </footer>

    <script src="api-config.js"></script>
    <script src="header.js"></script>
    <script src="footer.js"></script>
    <script>
        if (!token) window.location.href = 'login.html';

        function showMsg(text, type) {
            const msgBox = document.getElementById('msg-box');
            msgBox.textContent = text;
            msgBox.className = `status-msg ${type}`;
            msgBox.style.display = 'block';
            window.scrollTo(0, 0);
            setTimeout(() => { msgBox.style.display = 'none'; }, 5000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        function toggleEdit(type) {
            const view = document.getElementById(`${type}-view`);
            const form = document.getElementById(`${type}Form`);
            if (view.style.display === 'none') { view.style.display = 'block'; form.style.display = 'none'; }
            else { view.style.display = 'none'; form.style.display = 'block'; }
        }

        async function loadAccount() {
            try {
                const response = await fetch(${API_CONFIG.endpoints.account}/profile', {
                    headers: { }
                });
                const data = await response.json();
                
                if (data.success) {
                    const fullName = `${data.user.first_name || ''} ${data.user.last_name || ''}`.trim();

                    // Load Shipping View & Form
                    document.getElementById('view_ship_name').textContent = fullName || data.user.email;
                    document.getElementById('view_ship_address').textContent = data.user.address || 'Not set';
                    document.getElementById('view_ship_citystate').textContent = `${data.user.city || ''}, ${data.user.state || ''} ${data.user.zip || ''}`;
                    
                    document.getElementById('ship_name').value = fullName;
                    document.getElementById('ship_address').value = data.user.address || '';
                    document.getElementById('ship_city').value = data.user.city || '';
                    document.getElementById('ship_state').value = data.user.state || '';
                    document.getElementById('ship_zip').value = data.user.zip || '';

                    // Load Billing View & Form
                    document.getElementById('view_bill_name').textContent = data.user.billing_name || fullName;
                    document.getElementById('view_bill_address').textContent = data.user.billing_address || 'Same as shipping';
                    document.getElementById('view_bill_citystate').textContent = `${data.user.billing_city || ''}, ${data.user.billing_state || ''} ${data.user.billing_zip || ''}`;

                    document.getElementById('bill_name').value = data.user.billing_name || fullName;
                    document.getElementById('bill_address').value = data.user.billing_address || '';
                    document.getElementById('bill_city').value = data.user.billing_city || '';
                    document.getElementById('bill_state').value = data.user.billing_state || '';
                    document.getElementById('bill_zip').value = data.user.billing_zip || '';

                    // --- LOAD DOGS (NEW FULL WIDTH LAYOUT) ---
                    const dogsContainer = document.getElementById('dogs-container');
                    if (data.dogs && data.dogs.length > 0) {
                        dogsContainer.innerHTML = data.dogs.map(dog => `
                            <div class="dog-full-profile">
                                <div class="dog-info-side">
                                    <h3>${dog.dog_name}</h3>
                                    <p class="license-tag">License ID: ${dog.license_id}</p>
                                    
                                    <form onsubmit="updateDog(event, '${dog.id}')" class="dog-details-form">
                                        <div class="form-row">
                                            <div class="form-group-half">
                                                <label>Breed</label>
                                                <input type="text" name="breed" value="${dog.breed || ''}" placeholder="e.g. Golden Retriever">
                                            </div>
                                            <div class="form-group-half">
                                                <label>Birthday</label>
                                                <input type="text" name="birthday" value="${dog.birthday || ''}" placeholder="MM/DD/YYYY">
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group-third">
                                                <label>Weight (lbs)</label>
                                                <input type="text" name="weight" value="${dog.weight || ''}" placeholder="50">
                                            </div>
                                            <div class="form-group-third">
                                                <label>Height (in)</label>
                                                <input type="text" name="height" value="${dog.height || ''}" placeholder="24">
                                            </div>
                                            <div class="form-group-third">
                                                <label>Eye Color</label>
                                                <input type="text" name="eye_color" value="${dog.eye_color || ''}" placeholder="Brown">
                                            </div>
                                        </div>
                                        <button type="submit" class="cta-button small-btn">Save Dog Details</button>
                                    </form>
                                </div>
                                <div class="dog-photo-side">
                                    ${dog.photo_url ? 
                                        `<img src="' + API_CONFIG.r2Origin + '/${dog.photo_url}" 
                                              alt="${dog.dog_name}" 
                                              onerror="this.onerror=null;this.src='default-pfp.png';">` 
                                        : '<div class="no-photo">No Photo</div>'}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        dogsContainer.innerHTML = '<p>No certified dogs yet. <a href="add-dog.html">Certify your first dog!</a></p>';
                    }

                    // Load Orders
                    const ordersContainer = document.getElementById('orders-container');
                    if (data.orders && data.orders.length > 0) {
                        ordersContainer.innerHTML = data.orders.map(order => `
                            <div style="background:white; padding:1.5rem; margin-bottom:1rem; border-radius:8px; border:1px solid #eee;">
                                <h3>Order for ${order.dog_name}</h3>
                                <p><strong>Date:</strong> ${new Date(order.paid_at).toLocaleDateString()}</p>
                                <p><strong>License:</strong> ${order.license_id}</p>
                                <p><strong>Status:</strong> <span style="color:green">Paid</span></p>
                            </div>
                        `).join('');
                    } else {
                        ordersContainer.innerHTML = '<p>No orders yet.</p>';
                    }
                }
            } catch (error) {
                showMsg('Error loading account', 'error');
                console.error(error);
            }
        }

        // FUNCTION TO UPDATE DOG
        async function updateDog(event, dogId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch(${API_CONFIG.endpoints.account}/update-dog', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...data, dog_id: dogId })
                });
                const result = await response.json();
                if (result.success) showMsg('Dog details updated!', 'success');
                else showMsg('Failed to update dog', 'error');
            } catch (error) {
                showMsg('Error updating dog', 'error');
            }
        }

        // Shipping form handler
        document.getElementById('shippingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const nameParts = data.ship_name.trim().split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';

            try {
                const response = await fetch(${API_CONFIG.endpoints.account}/update', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        first_name: firstName, last_name: lastName,
                        address: data.ship_address, city: data.ship_city,
                        state: data.ship_state, zip: data.ship_zip
                    })
                });
                if ((await response.json()).success) {
                    showMsg('Shipping address updated!', 'success');
                    toggleEdit('shipping');
                    loadAccount(); // Refresh view
                } else showMsg('Failed to update', 'error');
            } catch (e) { showMsg('Error updating address', 'error'); }
        });

        // Billing form handler
        document.getElementById('billingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            try {
                const response = await fetch(${API_CONFIG.endpoints.account}/update-billing', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        billing_name: data.bill_name,
                        billing_address: data.bill_address,
                        billing_city: data.bill_city,
                        billing_state: data.bill_state,
                        billing_zip: data.bill_zip
                    })
                });
                if ((await response.json()).success) {
                    showMsg('Billing address updated!', 'success');
                    toggleEdit('billing');
                    loadAccount(); // Refresh view
                } else showMsg('Failed to update', 'error');
            } catch (e) { showMsg('Error updating address', 'error'); }
        });

        // Password form handler
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPass = document.getElementById('new_password').value;
            const confirmPass = document.getElementById('confirm_password').value;
            if (newPass !== confirmPass) { showMsg('Passwords do not match', 'error'); return; }

            try {
                const response = await fetch(${API_CONFIG.endpoints.account}/change-password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password: document.getElementById('current_password').value, new_password: newPass })
                });
                const result = await response.json();
                if (result.success) { showMsg('Password changed!', 'success'); document.getElementById('passwordForm').reset(); }
                else showMsg(result.error || 'Failed', 'error');
            } catch (e) { showMsg('Error changing password', 'error'); }
        });

        loadAccount();
    </script>
</body>
</html>